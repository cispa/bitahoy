from struct import unpack

from watchdog.network.protocols import arp_packet, icmp_echo, ip_packet

arp_capture = (
    b"\xf8\x34\x41\x35\xaf\x16\xb8\x59\x9f\xbc\x24\x5e\x08\x06\x00\x01"
    b"\x08\x00\x06\x04\x00\x01\xb8\x59\x9f\xbc\x24\x5e\x0a\x11\xd1\x01"
    b"\x00\x00\x00\x00\x00\x00\x0a\x11\xd1\xce"
)

# EthernetII frame included
udp_capture = (
    b"\xb8\x59\x9f\xbc\x24\x5e\xf8\x34\x41\x35\xaf\x16\x08\x00\x45\x00"
    b"\x00\x3e\x1b\xea\x40\x00\x40\x11\xed\x5f\x0a\x11\xd1\xce\x4a\x7d"
    b"\x0b\x09\xc8\xa0\x01\xbb\x00\x2a\x14\x21\x54\x87\x02\x2e\xd9\x3e"
    b"\xfb\x08\x16\x2c\x82\xc7\xa8\x75\xd3\x04\x26\x4f\x1b\x61\xa6\xa2"
    b"\x64\x73\xfd\xd8\xe1\xc5\x9d\x02\x57\x92\x8f\x52"
)

# EthernetII frame included
icmp_capture = (
    b"\xb8\x59\x9f\xbc\x24\x5e\xf8\x34\x41\x35\xaf\x16\x08\x00\x45\x00"
    b"\x00\x54\xc8\xec\x40\x00\x40\x01\xd4\x33\x0a\x11\xd1\xce\xc0\xa8"
    b"\x01\x01\x08\x00\x6b\x16\x00\x08\x00\x01\xe0\x0a\xdf\x60\x00\x00"
    b"\x00\x00\x04\xa2\x0a\x00\x00\x00\x00\x00\x10\x11\x12\x13\x14\x15"
    b"\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25"
    b"\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35"
    b"\x36\x37"
)


def test_arp_packet():
    packet = arp_packet(
        b"\xf8\x34\x41\x35\xaf\x16",
        b"\xb8\x59\x9f\xbc\x24\x5e",
        1,
        b"\xb8\x59\x9f\xbc\x24\x5e",
        b"\x0a\x11\xd1\x01",
        b"\x00" * 6,
        b"\x0a\x11\xd1\xce",
    )
    assert arp_capture == packet


def test_arp_packet_tupleargs():
    arp_params = (1, b"\xb8\x59\x9f\xbc\x24\x5e", b"\x0a\x11\xd1\x01", b"\x00" * 6, b"\x0a\x11\xd1\xce")
    packet = arp_packet(b"\xf8\x34\x41\x35\xaf\x16", b"\xb8\x59\x9f\xbc\x24\x5e", *arp_params)
    assert arp_capture == packet


def test_ip_packet1():
    onlyIPv4 = udp_capture[14:]
    packet = ip_packet(b"\x0a\x11\xd1\xce", b"\x4a\x7d\x0b\x09", onlyIPv4[-42:], identification=0x1BEA, ttl=0x40, proto=0x11)
    assert len(onlyIPv4) == len(packet)
    assert onlyIPv4 == packet


def test_ip_packet2():
    pass


def test_icmp_echo():
    packet = icmp_capture
    ipv4 = packet[14:]
    icmp_packet = packet[0x22:]
    timestamp = unpack("<II", icmp_packet[8:16])[0]
    assert ipv4 == ip_packet(b"\x0a\x11\xd1\xce", b"\xc0\xa8\x01\x01", ipv4[-0x40:], identification=0xC8EC, ttl=64, proto=1)
    assert icmp_packet == icmp_echo(identifier=8, sequencenumber=1, timestamp=timestamp, payload=icmp_packet[-48:])
