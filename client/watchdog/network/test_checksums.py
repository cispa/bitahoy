from watchdog.network.checksums import fix_ip_checksum, u16

tls_packet = (
    b"\xb8\x59\x9f\xbc\x24\x5e\xf8\x34\x41\x35\xaf\x16\x08\x00\x45\x00"
    b"\x00\x34\x71\xb4\x40\x00\x40\x06\xef\xc3\x0a\x11\xd1\xce\x8c\x52"
    b"\x71\x1a\xd4\x78\x01\xbb\xe8\x76\x90\x50\x0c\x7c\x1d\x90\x80\x10"
    b"\x01\x25\x32\x6d\x00\x00\x01\x01\x08\x0a\x81\x1d\x73\x65\xde\x60"
    b"\x1d\xf4"
)


def test_ip_checksum_1():
    packet = b"\xdc\xdc\xe2\xa7\xe1\x62\xdc\xa6\x32\x47\xaf\x1d\x08\x00\x45\x00\x00\xdf\x23\x86\x40\x00\x40\x11\x31\xac\xc0\xa8\xb2\x01\xc0\xa8\xb2\x2b\x00\x35\x04\xb9\x00\xcb\x51\xa9\x7d\x5a\x81\x80\x00\x01\x00\x03\x00\x00\x00\x01\x02\x61\x64\x08\x79\x69\x65\x6c\x64\x6c\x61\x62\x03\x6e\x65\x74\x00\x00\x01\x00\x01\x02\x61\x64\x08\x79\x69\x65\x6c\x64\x6c\x61\x62\x03\x6e\x65\x74\x00\x00\x05\x00\x01\x00\x00\x15\x32\x00\x1a\x08\x79\x69\x65\x6c\x64\x6c\x61\x62\x03\x6e\x65\x74\x07\x65\x64\x67\x65\x6b\x65\x79\x03\x6e\x65\x74\x00\x08\x79\x69\x65\x6c\x64\x6c\x61\x62\x03\x6e\x65\x74\x07\x65\x64\x67\x65\x6b\x65\x79\x03\x6e\x65\x74\x00\x00\x05\x00\x01\x00\x00\x10\x06\x00\x18\x05\x65\x33\x31\x32\x30\x01\x67\x0a\x61\x6b\x61\x6d\x61\x69\x65\x64\x67\x65\x03\x6e\x65\x74\x00\x05\x65\x33\x31\x32\x30\x01\x67\x0a\x61\x6b\x61\x6d\x61\x69\x65\x64\x67\x65\x03\x6e\x65\x74\x00\x00\x01\x00\x01\x00\x00\x00\x09\x00\x04\x00\x00\x00\x00\x00\x00\x29\x10\x00\x00\x00\x00\x00\x00\x00"
    np = fix_ip_checksum(packet)
    result = u16(np[24:26])
    assert result == 0x310A, hex(result)


def test_ip_checksum_2():
    broken_checksum = tls_packet[:24] + b"\x00\x00" + tls_packet[26:]
    assert fix_ip_checksum(broken_checksum) == tls_packet
